<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ—¥æœ¬èªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    /* ============== THEME (å­£ç¯€ã§è‰²å¤‰æ›´) ============== */
    :root{
      /* Default (will be overridden by season) */
      --bg:#0f1115; --card:#171a21; --text:#e9eef5; --muted:#9fb0c3; --accent:#76baff;
      --ok:#9ae6b4; --warn:#fcd34d; --danger:#fca5a5; --border:#263142;
    }
    /* æ˜¥ */
    .theme-spring{
      --bg:#0f1410; --card:#151c16; --text:#eef6ee; --muted:#a7c8ac; --accent:#f59ac2;
      --ok:#9ae6b4; --warn:#f7d58a; --danger:#f7a5a5; --border:#29422d;
    }
    /* å¤ */
    .theme-summer{
      --bg:#0e1218; --card:#111827; --text:#eaf2ff; --muted:#a3b6d6; --accent:#4db2ff;
      --ok:#8fe6d2; --warn:#ffe08a; --danger:#ff9aa2; --border:#22334a;
    }
    /* ç§‹ */
    .theme-autumn{
      --bg:#12100e; --card:#1a1713; --text:#f5efe6; --muted:#c7b9a3; --accent:#e67e22;
      --ok:#bde0b6; --warn:#f4c58a; --danger:#f2a8a8; --border:#3b3025;
    }
    /* å†¬ */
    .theme-winter{
      --bg:#0f1115; --card:#171a21; --text:#e9eef5; --muted:#9fb0c3; --accent:#9cc2f7;
      --ok:#9ae6b4; --warn:#d8cc8a; --danger:#e8a5a5; --border:#263142;
    }

    /* ============== LAYOUT / STYLE ============== */
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic", sans-serif;
      display:flex; flex-direction:column; gap:12px; padding:12px;
      transition: background .4s ease, color .4s ease;
    }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 760px){
      .grid{ grid-template-columns: 1.1fr 0.9fr; }
    }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:14px; box-shadow: 0 6px 16px rgb(0 0 0 / 35%);
    }
    .title{
      display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.02em;
      margin:0 0 10px 0; font-size:20px;
    }
    .sub{ color:var(--muted); font-size:13px }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .pill{ padding:4px 8px; border-radius:999px; font-size:12px; background:#10131a; border:1px solid var(--border); color:var(--muted) }
    .big{ font-size:20px; line-height:1.4 }
    .jp{ font-feature-settings:"palt"; }
    .mono{ font-variant-numeric: tabular-nums; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      display:flex; justify-content:space-between; align-items:center;
      background:#121620; border:1px solid var(--border); border-radius:10px; padding:10px;
    }
    .item small{ color:var(--muted) }
    .badge{ font-size:12px; padding:4px 8px; border-radius:8px; background:#0f1b2a; border:1px solid #28435e; }
    .ok{ border-color:#2a5e45; background:#0e1f18; color:var(--ok) }
    .warn{ border-color:#5e4c2a; background:#1f1a0e; color:var(--warn) }
    .danger{ border-color:#5e2a2a; background:#1f0e0e; color:var(--danger) }
    button{
      background:linear-gradient(180deg,#1f2632,#1a1f2b); border:1px solid #2b3648; color:var(--text);
      padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer; touch-action:manipulation;
    }
    button:active{ transform: translateY(1px) }
    .muted{ color:var(--muted) }
    .spacer{ height:6px }
    .hr{ height:1px; background:var(--border); margin:8px 0; opacity:.6 }

    /* ãƒ‹ãƒ¥ãƒ¼ã‚¹æœ¬æ–‡å®‰å…¨åŸŸ */
    #newsBody p{ margin:.4em 0 }
    #newsBody ruby rt{ font-size:.75em; }

    /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ */
    .spark-wrap{ display:flex; align-items:center; gap:8px }
    .spark-wrap canvas{ width:120px; height:36px; border-radius:6px; background:#0f1420; border:1px solid var(--border) }
  </style>
</head>
<body>
  <!-- ===== HEADER : æ—¥ä»˜ï¼ˆä»¤å’Œï¼‹æ›œæ—¥ï¼‰/ å­£ç¯€é…è‰² ===== -->
  <div class="card">
    <h1 class="title">ğŸ—“ ä»Šæ—¥<span class="pill" id="greg"></span></h1>
    <div class="row big jp">
      <div id="dateJP" class="mono"></div>
      <div class="pill" id="eraJP"></div>
      <div class="pill" id="weekdayJP"></div>
      <div class="pill" id="seasonJP"></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <label class="pill">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼š</label>
      <select id="profileSelect" class="pill">
        <option value="bastian">ãƒã‚¹ãƒãƒ£ãƒ³</option>
        <option value="axelle">ã‚¢ã‚¯ã‚»ãƒ«</option>
      </select>
    </div>
  </div>

  <div class="grid">
    <!-- ===== å¤©æ°—ï¼ˆæ–‡ç« ï¼‰ ===== -->
    <section class="card">
      <h2 class="title">â›… å¤©æ°—</h2>
      <div class="list jp">
        <div id="wxSummary" class="big">ï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰</div>
        <div id="wxDetail" class="">â€”</div>
        <div id="wxHints" class="muted">â€”</div>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <span class="pill" id="wxCity">åœ°åŸŸï¼šâ€”</span>
        <span class="pill" id="wxTemp">æœ€é«˜â€”â„ƒ / æœ€ä½â€”â„ƒ</span>
        <span class="pill" id="wxRain">é™æ°´ç¢ºç‡ï¼šâ€”%</span>
        <span class="pill" id="wxWind">é¢¨ï¼šâ€”m/sï¼ˆâ€”ï¼‰</span>
      </div>
    </section>

    <!-- ===== èª•ç”Ÿæ—¥ï¼ˆä»Šæ—¥ï¼7æ—¥ä»¥å†…ï¼‰ ===== -->
    <section class="card">
      <h2 class="title">ğŸ‚ èª•ç”Ÿæ—¥</h2>

      <div id="bdayTodayWrap" style="display:none;">
        <div class="row" style="margin-bottom:8px;">
          <span class="badge ok">ä»Šæ—¥ã¯ãŠç¥ã„ï¼</span>
        </div>
        <div id="bdayToday" class="list"></div>
      </div>

      <div id="bdayUpcomingWrap" style="display:none; margin-top:12px;">
        <div class="row" style="margin-bottom:8px;">
          <span class="badge">ã‚‚ã†ã™ãï¼ˆ7æ—¥ä»¥å†…ï¼‰</span>
        </div>
        <div id="bdayUpcoming" class="list"></div>
      </div>

      <div id="bdayEmpty" class="muted">ä»Šé€±ã®èª•ç”Ÿæ—¥ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      <div class="spacer"></div>
      <div class="row"><button id="copyMsg">ãŠã‚ã§ã¨ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼</button></div>
    </section>
  </div>

  <!-- ===== ä»Šæ—¥ã®æ¼¢å­— ===== -->
  <section class="card" id="kanjiCard">
    <h2 class="title">ğŸˆ¶ ä»Šæ—¥ã®æ¼¢å­—</h2>
    <div class="big jp" id="kanjiChar">â€”</div>
    <div class="row">
      <span class="pill" id="kanjiRead">éŸ³ï¼šâ€”ã€€è¨“ï¼šâ€”</span>
      <span class="pill" id="kanjiMeta">â€”</span>
    </div>
    <div class="spacer"></div>
    <div class="jp" id="kanjiVocab">ä¾‹èªï¼šâ€”</div>
    <div class="jp" id="kanjiSentence">â€”</div>
    <div class="row" style="margin-top:8px;">
      <button id="kanjiDone">è¦šãˆãŸ â†’ æ¬¡ã®æ¼¢å­—</button>
    </div>
  </section>

  <!-- ===== ä»Šæ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ ===== -->
  <section class="card" id="newsCard">
    <h2 class="title">ğŸ“° ä»Šæ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
    <div class="jp big" id="newsTitle">â€”</div>
    <div class="muted jp" id="newsLead">â€”</div>
    <div class="jp" id="newsBody"><p>â€”</p></div>
    <div class="row" style="margin-top:8px;">
      <button id="newsOpen">å…¨æ–‡</button>
    </div>
  </section>

  <!-- ===== EUR/JPYï¼ˆBCEï¼‰ ===== -->
  <section class="card" id="fxCard">
    <h2 class="title">ğŸ’± EUR/JPYï¼ˆæ—¥æ¬¡ãƒ»BCEï¼‰</h2>
    <div class="row">
      <span class="pill" id="fxDate">â€”</span>
      <span class="pill" id="fxSpot">â€”</span>
      <span class="pill" id="fxDelta">â€”</span>
    </div>
    <div class="spacer"></div>
    <div class="spark-wrap">
      <canvas id="fxSpark" width="120" height="36" aria-label="EURJPY sparkline"></canvas>
      <span class="muted" id="fxNote">éå»7å–¶æ¥­æ—¥ï¼ˆå‚è€ƒï¼‰</span>
    </div>
  </section>

  <script>
    /* ========= UTIL ========= */
    const pad = (n)=> String(n).padStart(2,'0');
    const jpWeek = ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"];
    const now = new Date();
    const PROFILE_KEY = "jp_dash_profile";

    /* ========= SAISON & EN-TÃŠTE ========= */
    function seasonByMonth(m){ // 1-12
      if([3,4,5].includes(m)) return "spring";
      if([6,7,8].includes(m)) return "summer";
      if([9,10,11].includes(m)) return "autumn";
      return "winter"; // 12,1,2
    }
    function applySeasonTheme(){
      const s = seasonByMonth(now.getMonth()+1);
      document.body.classList.remove("theme-spring","theme-summer","theme-autumn","theme-winter");
      document.body.classList.add(`theme-${s}`);
      const names = {spring:"æ˜¥", summer:"å¤", autumn:"ç§‹", winter:"å†¬"};
      document.getElementById("seasonJP").textContent = `å­£ç¯€ï¼š${names[s]}`;
    }
    function reiwaYear(y,m,d){
      const after = (y>2019)|| (y===2019 && (m>5 || (m===5 && d>=1)));
      if(!after) return null;
      return y-2018;
    }
    function renderHeader(){
      const y=now.getFullYear(), m=now.getMonth()+1, d=now.getDate();
      document.getElementById("greg").textContent = `${y}-${pad(m)}-${pad(d)}`;
      document.getElementById("dateJP").textContent = `${y}å¹´${m}æœˆ${d}æ—¥`;
      const ry = reiwaYear(y,m,d);
      document.getElementById("eraJP").textContent = ry ? `ä»¤å’Œ${ry}å¹´` : "ä»¤å’Œå‰";
      const weekday = (now.getDay()+6)%7; // 0=Mon
      document.getElementById("weekdayJP").textContent = `ï¼ˆ${jpWeek[weekday]}ï¼‰`;
    }
    applySeasonTheme(); renderHeader();

    /* ========= å¤©æ°—ï¼ˆãƒ‡ãƒ¢ or APIï¼‰ =========
       Attendu cÃ´tÃ© backend : /api/weather/today -> {
         city, cond, tmax, tmin, rainProb, windMs, windDir, deltaFromYesterday
       } æ–‡å­—åˆ—ã¯æ—¥æœ¬èªï¼ˆcond, windDirï¼‰ã€‚
    */
    async function loadWeather(){
      try{
        const r = await fetch('/api/weather/today');
        if(!r.ok) throw new Error(r.status);
        const w = await r.json();

        document.getElementById("wxCity").textContent    = `åœ°åŸŸï¼š${w.city || "â€”"}`;
        document.getElementById("wxSummary").textContent = w.cond || "â€”";
        document.getElementById("wxTemp").textContent    = `æœ€é«˜${w.tmax ?? "â€”"}â„ƒ / æœ€ä½${w.tmin ?? "â€”"}â„ƒ`;
        document.getElementById("wxRain").textContent    = `é™æ°´ç¢ºç‡ï¼š${w.rainProb ?? "â€”"}%`;
        document.getElementById("wxWind").textContent    = `é¢¨ï¼š${w.windMs ?? "â€”"}m/sï¼ˆ${w.windDir || "â€”"}ï¼‰`;

        // dÃ©tail horaire (optionnel) â†’ rempli avec info gÃ©nÃ©rÃ©e si disponible
        document.getElementById("wxDetail").textContent  = w.detail || "â€”";

        // hints : phrase naturelle + lever/coucher
        let hint = w.hint || "";
        const ss = [];
        if (w.sunrise) ss.push(`æ—¥ã®å‡º ${w.sunrise.slice(11,16)}`);
        if (w.sunset)  ss.push(`æ—¥æ²¡ ${w.sunset.slice(11,16)}`);
        if (ss.length) hint = hint ? `${hint} ï¼ˆ${ss.join("ãƒ»")}ï¼‰` : `ï¼ˆ${ss.join("ãƒ»")}ï¼‰`;

        document.getElementById("wxHints").textContent   = (w.hint || "â€”") + (w.sunrise && w.sunset ? ` ï¼ˆæ—¥ã®å‡º ${w.sunrise.slice(11,16)}ãƒ»æ—¥æ²¡ ${w.sunset.slice(11,16)}ï¼‰` : "");

      }catch(err){
        console.error("weather api error", err);
        document.getElementById("wxSummary").textContent = "â€”";
        document.getElementById("wxDetail").textContent  = "â€”";
        document.getElementById("wxHints").textContent   = "â€”";
        document.getElementById("wxCity").textContent    = "åœ°åŸŸï¼šâ€”";
        document.getElementById("wxTemp").textContent    = "æœ€é«˜â€”â„ƒ / æœ€ä½â€”â„ƒ";
        document.getElementById("wxRain").textContent    = "é™æ°´ç¢ºç‡ï¼šâ€”%";
        document.getElementById("wxWind").textContent    = "é¢¨ï¼šâ€”m/sï¼ˆâ€”ï¼‰";
      }
    }

    /* ========= èª•ç”Ÿæ—¥ï¼ˆä»Šæ—¥ï¼7æ—¥ä»¥å†…ï¼‰ =========
       /api/birthdays -> { today:[{name,kana,date_str,age,days_until}], upcoming:[...] }
       â€» name/kana ã¯ã‚«ã‚¿ã‚«ãƒŠã§ç”¨æ„
    */
    function renderBirthdays(data){
      const todayWrap = document.getElementById("bdayTodayWrap");
      const upcomingWrap = document.getElementById("bdayUpcomingWrap");
      const empty = document.getElementById("bdayEmpty");
      const todayEl = document.getElementById("bdayToday");
      const upcomingEl = document.getElementById("bdayUpcoming");

      const mkItemToday = (e)=>{
        const div = document.createElement("div"); div.className="item";
        const left = document.createElement("div");
        left.innerHTML = `<div class="jp">ä»Šæ—¥ã¯<strong>${e.name}</strong>ã•ã‚“ã®èª•ç”Ÿæ—¥ã§ã™ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
                          <small class="muted">${e.kana ? e.kana+"ãƒ»" : ""}${e.date_str}${e.age? ` ãƒ» ${e.age}æ­³`: ""}</small>`;
        const right = document.createElement("div");
        right.innerHTML = `<span class="badge ok">ğŸ‰</span>`;
        div.append(left,right);
        return div;
      };
      const mkItemUpcoming = (e)=>{
        const div = document.createElement("div"); div.className="item";
        const left = document.createElement("div");
        left.innerHTML = `<div class="jp">${e.date_str}ï¼š<strong>${e.name}</strong>ã•ã‚“${e.age? `ï¼ˆ${e.age}æ­³ï¼‰`:""}</div>
                          <small class="muted">${e.kana ? e.kana : ""}</small>`;
        const right = document.createElement("div");
        right.innerHTML = `<span class="badge">ã‚ã¨${e.days_until}æ—¥</span>`;
        div.append(left,right);
        return div;
      };

      todayEl.innerHTML = ""; upcomingEl.innerHTML = "";
      if(data.today && data.today.length){
        todayWrap.style.display="block";
        data.today.forEach(e=> todayEl.appendChild(mkItemToday(e)));
      }else{
        todayWrap.style.display="none";
      }
      if(data.upcoming && data.upcoming.length){
        upcomingWrap.style.display="block";
        data.upcoming.forEach(e=> upcomingEl.appendChild(mkItemUpcoming(e)));
      }else{
        upcomingWrap.style.display="none";
      }
      empty.style.display = ((!data.today || !data.today.length) && (!data.upcoming || !data.upcoming.length)) ? "block":"none";
    }


    document.getElementById("copyMsg").addEventListener("click", async ()=>{
      const msg = "ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ç´ æ•µãªä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚";
      try{ await navigator.clipboard.writeText(msg); alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
      catch{ alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    });

    /* ========= ä»Šæ—¥ã®æ¼¢å­— =========
      /api/kanji/today ou /api/kanji/random
    */

    // rendu dâ€™un kanji dans la carte
    function renderKanji(k){
      // caractÃ¨re
      document.getElementById('kanjiChar').textContent = k.char || "â€”";

      // lectures
      const ons  = (k.on||[]).join("ãƒ»") || "â€”";
      const kuns = (k.kun||[]).join("ãƒ»") || "â€”";
      document.getElementById('kanjiRead').textContent = `éŸ³ï¼š${ons}ã€€è¨“ï¼š${kuns}`;

      // JLPT niveau + sens
      document.getElementById('kanjiMeta').textContent = `${k.level || "â€”"}ï½œ${k.meaning || "â€”"}`;

      // vocabulaire (avec furigana si dispo)
      const vocabHTML = (k.vocab||[])
        .map(v => v && v.w ? (v.r ? `<ruby><rb>${v.w}</rb><rt>${v.r}</rt></ruby>` : v.w) : "")
        .filter(Boolean).join("ãƒ»") || "â€”";
      document.getElementById('kanjiVocab').innerHTML = `ä¾‹èªï¼š${vocabHTML}`;
    }

    // charge le kanji du jour
    async function loadKanjiToday(){
      try{
        const r = await fetch('/api/kanji/today');
        if(!r.ok) throw new Error();
        const k = await r.json();
        renderKanji(k);
      }catch(err){
        console.error("kanji api error", err);
        renderKanji({});
      }
    }

    // charge un kanji alÃ©atoire (excluant ceux dÃ©jÃ  vus si possible)
    async function loadKanjiRandom(){
      try{
        const r = await fetch('/api/kanji/random');
        if(!r.ok) throw new Error();
        const k = await r.json();
        renderKanji(k);
      }catch(err){
        console.error("kanji random api error", err);
        renderKanji({});
      }
    }

    // bouton è¦šãˆãŸ â†’ æ¬¡ã®æ¼¢å­—
    document.getElementById('kanjiDone').onclick = ()=>{
      loadKanjiRandom();
    };

    // init au chargement
    loadKanjiToday();


    /* ========= ä»Šæ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ =========
       /api/news/today -> { title, lead, html, url }
    */
    async function loadNews(){
      try{
        const r = await fetch('/api/news/today');
        if(!r.ok) throw new Error();
        const n = await r.json();
        document.getElementById('newsTitle').textContent = n.title || "â€”";
        document.getElementById('newsLead').textContent = n.lead || "";
        document.getElementById('newsBody').innerHTML = n.html || "<p>â€”</p>";
        document.getElementById('newsOpen').onclick = ()=> n.url && window.open(n.url,'_blank');
      } catch(err){
        console.error("news api error", err);
        document.getElementById('newsTitle').textContent = "â€”";
        document.getElementById('newsLead').textContent = "";
        document.getElementById('newsBody').innerHTML = "<p>â€”</p>";
        document.getElementById('newsOpen').onclick = ()=> {};
      }
    }


    /* ========= EUR/JPYï¼ˆBCEï¼‰ =========
       Plan A: backend /api/fx/eurjpy -> { date, spot, history:[{date, value}] } (7-10 derniers)
       Plan B: direct ECB XML:
         - https://www.ecb.europa.eu/stats/eurofxref/eurofxref-daily.xml
         - https://www.ecb.europa.eu/stats/eurofxref/eurofxref-hist-90d.xml
       NOTE: CORS peut bloquer en file:// â†’ mieux via backend proxy.
    */
    function drawSpark(canvas, values){
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      if(!values || values.length<2){ return; }
      const min = Math.min(...values), max = Math.max(...values);
      const padX = 4, padY = 4;
      const nx = (i)=> padX + (w-2*padX) * (i/(values.length-1));
      const ny = (v)=> {
        if(max===min) return h/2;
        return h - padY - (h-2*padY) * ((v-min)/(max-min));
      };
      ctx.beginPath();
      ctx.moveTo(nx(0), ny(values[0]));
      for(let i=1;i<values.length;i++){ ctx.lineTo(nx(i), ny(values[i])); }
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#8ab6ff";
      ctx.stroke();
    }

    async function loadFX(){
      const fxDate = document.getElementById('fxDate');
      const fxSpot = document.getElementById('fxSpot');
      const fxDelta = document.getElementById('fxDelta');
      const spark = document.getElementById('fxSpark');

      async function planA(){
        const r = await fetch('/api/fx/eurjpy');
        if(!r.ok) throw new Error();
        return await r.json();
      }
      async function planB(){
        // Parse ECB 90d XML, extract last ~7 days of JPY
        const url = 'https://www.ecb.europa.eu/stats/eurofxref/eurofxref-hist-90d.xml';
        const res = await fetch(url);
        if(!res.ok) throw new Error('ECB fetch failed');
        const txt = await res.text();
        const dom = new DOMParser().parseFromString(txt, "text/xml");
        const cubes = [...dom.querySelectorAll("Cube[time]")];
        const hist = [];
        cubes.forEach(day=>{
          const t = day.getAttribute("time");
          const j = [...day.querySelectorAll("Cube[currency='JPY']")][0];
          if(j){
            const v = parseFloat(j.getAttribute("rate"));
            hist.push({date:t, value:v});
          }
        });
        hist.sort((a,b)=> a.date.localeCompare(b.date)); // oldestâ†’newest
        const last = hist[hist.length-1];
        // Slice last 7 business days
        const tail = hist.slice(-7);
        return { date:last.date, spot:last.value, history:tail };
      }

      try{
        const data = await planA().catch(planB);
        fxDate.textContent = data.date || "â€”";
        fxSpot.textContent = `EUR/JPYï¼š${(data.spot||0).toFixed(3)}`;
        if(data.history && data.history.length>=2){
          const vals = data.history.map(x=> x.value);
          const d = vals[vals.length-1] - vals[vals.length-2];
          fxDelta.textContent = `å‰æ—¥æ¯”ï¼š${d>=0?"+":""}${d.toFixed(3)}`;
          fxDelta.className = "pill " + (d>0?"ok": d<0?"danger":"");
          drawSpark(spark, vals);
        }else{
          fxDelta.textContent = "å‰æ—¥æ¯”ï¼šâ€”";
          drawSpark(spark, []);
        }
      }catch(e){
        fxDate.textContent = "â€”";
        fxSpot.textContent = "EUR/JPYï¼šâ€”";
        fxDelta.textContent = "å‰æ—¥æ¯”ï¼šâ€”";
      }
    }

    function getSavedProfile(){
      const url = new URL(window.location.href);
      const q = url.searchParams.get("profile");
      if(q){ localStorage.setItem(PROFILE_KEY, q); return q; }
      return localStorage.getItem(PROFILE_KEY) || "bastian";
    }

    function setCookieProfile(value){
      document.cookie = `profile=${value}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
    }

    async function loadBirthdaysWithProfile(profile){
      try{
        const res = await fetch(`/api/birthdays?profile=${profile}`);
        if(!res.ok) throw new Error(res.status);
        const data = await res.json();
        renderBirthdays(data);
      }catch(err){
        console.error("birthdays api error", err);
        renderBirthdays({ today:[], upcoming:[] }); // affiche â€œä»Šé€±ã®èª•ç”Ÿæ—¥ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚â€
      }
    }

    async function reloadAll(profile){
      setCookieProfile(profile);
      await loadBirthdaysWithProfile(profile);
      // plus tard :
      // await loadWeather(profile); await loadKanji(profile); await loadNews(profile);
      // si certains widgets deviennent eux aussi multi-profils
    }

    (function initProfile(){
      const p = getSavedProfile();
      document.getElementById("profileSelect").value = p;
      reloadAll(p);
      document.getElementById("profileSelect").addEventListener("change", (e)=>{
        const val = e.target.value;
        localStorage.setItem(PROFILE_KEY, val);
        const url = new URL(window.location.href);
        url.searchParams.set("profile", val);
        history.replaceState({}, "", url); // propre : URL reflÃ¨te lâ€™Ã©tat
        reloadAll(val);
      });
    })();

    const KANJI_LEARNED_KEY = "jp_dash_kanji_learned";

    function loadLearned(){
      try{ return new Set(JSON.parse(localStorage.getItem(KANJI_LEARNED_KEY) || "[]")); }
      catch{ return new Set(); }
    }
    function saveLearned(set){
      localStorage.setItem(KANJI_LEARNED_KEY, JSON.stringify([...set]));
    }

    // rendu du kanji (rÃ©utilise ta fonction existante si tu en as une)
    function renderKanji(k){
      document.getElementById('kanjiChar').textContent = k.char || "â€”";
      const ons = (k.on||[]).join("ãƒ»") || "â€”";
      const kuns = (k.kun||[]).join("ãƒ»") || "â€”";
      document.getElementById('kanjiRead').textContent = `éŸ³ï¼š${ons}ã€€è¨“ï¼š${kuns}`;
      document.getElementById('kanjiMeta').textContent = `${k.level || "â€”"}ï½œ${k.meaning || "â€”"}`;
      // vocab en ruby
      const vocabHTML = (k.vocab||[])
        .map(v => v && v.w ? (v.r ? `<ruby><rb>${v.w}</rb><rt>${v.r}</rt></ruby>` : v.w) : "")
        .filter(Boolean).join("ãƒ»") || "â€”";
      document.getElementById('kanjiVocab').innerHTML = `ä¾‹èªï¼š${vocabHTML}`;
    }

    async function fetchRandomKanji(excludeSet){
      const exclude = encodeURIComponent([...excludeSet].join(","));
      const url = exclude ? `/api/kanji/random?exclude=${exclude}` : `/api/kanji/random`;
      const r = await fetch(url);
      if(!r.ok) throw new Error(r.status);
      return r.json();
    }

    async function nextKanji(){
      const learned = loadLearned();
      // essaie 10 tirages max en excluant les appris
      let k;
      for(let i=0; i<10; i++){
        k = await fetchRandomKanji(learned);
        if(!k || !k.char) break;
        if(!learned.has(k.char)) break; // trouvÃ© un non-appris
      }
      // si tout appris, on accepte une rÃ©pÃ©tition
      if(!k || !k.char){ alert("æ¼¢å­—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
      renderKanji(k);
    }

    (function initKanjiButtons(){
      const btnDone = document.getElementById('kanjiDone');
      if(btnDone){
        btnDone.onclick = async ()=>{
          const cur = document.getElementById('kanjiChar').textContent.trim();
          if(cur && cur !== "â€”"){
            const s = loadLearned(); s.add(cur); saveLearned(s);
          }
          nextKanji();
        };
      }
      const btnFuri = document.getElementById('kanjiFuriToggle');
      if(btnFuri){
        btnFuri.onclick = ()=> toggleRuby('#kanjiCard'); // ta fonction existante
      }
    })();

    /* ========= INIT ========= */
    loadWeather();
    loadKanji();
    loadNews();
    loadFX();
  </script>
</body>
</html>
